<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Syntax Tree Builder</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      text-align: center;
      background-color: #f5f5f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Header with buttons flanking the title */
    .app-header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      padding: 6px 20px;
      background: #ffffff;
      border-bottom: 2px solid #ddd;
      flex-shrink: 0;
    }
    .app-header h1 {
      margin: 0;
      color: #333;
      font-size: 20px;
    }
    .header-left,
    .header-right {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .header-left {
      justify-content: flex-start;
    }
    .header-right {
      justify-content: flex-end;
      gap: 8px;
    }
    .export-btn {
      border: 1px solid #333;
      background: white;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      font-size: 13px;
      padding: 6px 10px;
      transition: background 0.2s;
    }
    .export-btn:hover {
      background: #f0f0f0;
    }
    .export-status {
      font-size: 11px;
      color: #666;
      margin: 0 10px;
      min-height: 1em;
    }

    /* Compact palette sections */
    .palette-section {
      background-color: #fff;
      border: 1px solid #ddd;
      margin: 4px 12px;
      padding: 6px 10px;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .palette-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 6px;
      margin: 0;
    }

    /* Palette tile sizes - wider to accommodate full names */
    .clauses-section .palette-tile {
      min-width: 130px;
      height: 32px;
      font-size: 12px;
      padding: 0 8px;
    }

    .phrases-section .palette-tile {
      min-width: 130px;
      height: 32px;
      font-size: 12px;
      padding: 0 8px;
    }

    .open-class-section .palette-tile {
      min-width: 80px;
      height: 32px;
      font-size: 12px;
      padding: 0 8px;
    }

    .closed-class-section .palette-tile {
      min-width: 100px;
      height: 32px;
      font-size: 11px;
      padding: 0 6px;
    }

    .palette-tile {
      border-radius: 5px;
      border: 2px solid rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: grab;
      user-select: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      white-space: nowrap;
    }

    .palette-tile:hover {
      transform: scale(1.05);
    }

    .palette-tile:active {
      cursor: grabbing;
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 100;
    }

    .palette-tile.white-bg {
      border: 2px solid #333;
      color: #333;
      background: white;
    }

    .palette-tile.dragging {
      opacity: 0.6;
    }

    /* Top and bottom palette containers */
    .top-palettes, .bottom-palettes {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 4px;
      padding: 4px 8px;
      flex-shrink: 0;
    }

    .top-palettes .palette-section,
    .bottom-palettes .palette-section {
      margin: 2px 4px;
    }

    /* Word input section */
    .word-input-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 8px 10px;
    }

    .word-input-section label {
      font-size: 13px;
      color: #333;
      font-weight: bold;
    }

    .word-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .word-input-section input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .word-input-section input:focus {
      border-color: #0066ff;
    }

    .word-preview-tile {
      min-width: 60px;
      height: 28px;
      padding: 0 12px;
      background: #fff;
      border: 2px dashed #999;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #333;
      cursor: grab;
      transition: all 0.2s;
    }

    .word-preview-tile:not(.empty) {
      border-style: solid;
      border-color: #333;
      background: #fafafa;
    }

    .word-preview-tile:not(.empty):hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .word-preview-tile.empty {
      color: #aaa;
      cursor: default;
    }

    /* Main content area */
    .main-content {
      display: flex;
      flex: 1;
      min-height: 0;
      gap: 8px;
      padding: 6px 12px;
    }

    .right-panel {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .right-panel .word-input-section {
      margin: 0;
    }

    .right-panel .bracket-panel {
      flex: 1;
      min-height: 0;
    }

    /* Canvas wrapper - fills remaining space */
    #canvas-wrapper {
      position: relative;
      background-color: #fff;
      border: 3px solid #333;
      border-radius: 8px;
      overflow: hidden;
      flex: 1;
      min-height: 200px;
    }

    .zoom-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 10;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .zoom-controls button {
      height: 26px;
      border: 1px solid #333;
      background: white;
      cursor: pointer;
      border-radius: 4px;
      font-weight: bold;
      font-size: 13px;
      padding: 0 6px;
    }

    #zoom-in, #zoom-out {
      width: 26px;
    }

    #zoom-reset {
      min-width: fit-content;
      font-size: 11px;
    }

    .zoom-controls button:hover {
      background: #f0f0f0;
    }

    .zoom-info {
      position: absolute;
      top: 8px;
      left: 8px;
      z-index: 10;
      font-size: 10px;
      color: #666;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    canvas { border: none; }

    /* Bracket editor panel */
    .bracket-panel {
      display: flex;
      flex-direction: column;
      background: #fff;
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

    .bracket-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f8f8f8;
      border-bottom: 1px solid #ddd;
    }

    .bracket-panel-header h3 {
      margin: 0;
      font-size: 13px;
      color: #333;
    }

    .bracket-panel-header .toggle-btn {
      font-size: 11px;
      padding: 4px 8px;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    .bracket-panel-header .toggle-btn:hover {
      background: #f0f0f0;
    }

    .bracket-textarea {
      flex: 1;
      width: 100%;
      padding: 12px;
      border: none;
      resize: none;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.5;
      outline: none;
      background: #fafafa;
    }

    .bracket-textarea:focus {
      background: #fff;
    }

    .bracket-status {
      padding: 6px 12px;
      font-size: 10px;
      color: #666;
      background: #f8f8f8;
      border-top: 1px solid #ddd;
    }

    .bracket-status.error {
      color: #c00;
      background: #fff0f0;
    }

    .bracket-status.editing {
      color: #0066ff;
      background: #f0f8ff;
    }

    .bracket-status.warning {
      color: #b86e00;
      background: #fff8e6;
    }

    /* Drag-over visual feedback for canvas */
    .upper-canvas.drag-over,
    #diagram-canvas.drag-over {
      outline: 3px dashed #0066ff;
      outline-offset: -3px;
      background-color: rgba(0, 102, 255, 0.03);
    }
  </style>

  <!-- Fabric.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
</head>
<body>
  <header class="app-header">
    <div class="header-left">
      <button id="copy-tree" class="export-btn">copy tree</button>
    </div>
    <h1>Syntax Tree Builder</h1>
    <div class="header-right">
      <span id="export-status" class="export-status"></span>
      <button id="download-tree" class="export-btn">download tree</button>
    </div>
  </header>

  <div class="top-palettes">
    <div class="palette-section clauses-section">
      <div class="palette-row">
        <div class="palette-tile white-bg" data-type="clause" data-value="S" data-abbrev="S" draggable="true">Sentence S</div>
        <div class="palette-tile white-bg" data-type="clause" data-value="IC" data-abbrev="IC" draggable="true">Independent Clause IC</div>
        <div class="palette-tile white-bg" data-type="clause" data-value="DC" data-abbrev="DC" draggable="true">Dependent Clause DC</div>
        <div class="palette-tile white-bg" data-type="clause" data-value="RC" data-abbrev="RC" draggable="true">Relative Clause RC</div>
        <div class="palette-tile white-bg" data-type="clause" data-value="CC" data-abbrev="CC" draggable="true">Complement Clause CC</div>
      </div>
    </div>

    <div class="palette-section phrases-section">
      <div class="palette-row">
        <div class="palette-tile" data-type="phrase" data-value="NP" data-abbrev="NP" style="background-color: #F1948A; color: #000;" draggable="true">Noun Phrase NP</div>
        <div class="palette-tile" data-type="phrase" data-value="VP" data-abbrev="VP" style="background-color: #58D68D; color: #000;" draggable="true">Verb Phrase VP</div>
        <div class="palette-tile" data-type="phrase" data-value="PP" data-abbrev="PP" style="background-color: #D7BDE2; color: #000;" draggable="true">Prepositional Phrase PP</div>
        <div class="palette-tile" data-type="phrase" data-value="ADJP" data-abbrev="ADJP" style="background-color: #F7DC6F; color: #000;" draggable="true">Adjective Phrase ADJP</div>
        <div class="palette-tile" data-type="phrase" data-value="ADVP" data-abbrev="ADVP" style="background-color: #85C1E9; color: #000;" draggable="true">Adverb Phrase ADVP</div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div id="canvas-wrapper">
      <div class="zoom-info">Drag near parent to connect | Ctrl+click to edit | Click lines to disconnect | Delete to remove</div>
      <div class="zoom-controls">
        <button id="zoom-in">+</button>
        <button id="zoom-out">-</button>
        <button id="zoom-reset">Reset</button>
      </div>
      <canvas id="diagram-canvas"></canvas>
    </div>

    <div class="right-panel">
      <div class="palette-section word-input-section">
        <label for="word-input">Add Word</label>
        <div class="word-input-row">
          <input type="text" id="word-input" placeholder="type here" autocomplete="off">
          <div class="word-preview-tile empty" id="word-preview" draggable="false">...</div>
        </div>
      </div>

      <div class="bracket-panel">
        <div class="bracket-panel-header">
          <h3>Bracket Notation</h3>
          <button class="toggle-btn" id="sync-toggle" title="Toggle auto-sync">Auto-sync: ON</button>
        </div>
        <textarea class="bracket-textarea" id="bracket-input" placeholder="[S [NP ...] [VP ...]]&#10;&#10;Type bracket notation here or build visually on the canvas. Both views stay synchronized."></textarea>
        <div class="bracket-status" id="bracket-status">Ready</div>
      </div>
    </div>
  </div>

  <div class="bottom-palettes">
    <div class="palette-section open-class-section">
      <div class="palette-row">
        <div class="palette-tile" data-type="pos" data-value="NOUN" data-abbrev="NOUN" style="background-color: #E74C3C; color: #000;" draggable="true">Noun NOUN</div>
        <div class="palette-tile" data-type="pos" data-value="VERB" data-abbrev="VERB" style="background-color: #27AE60; color: #000;" draggable="true">Verb VERB</div>
        <div class="palette-tile" data-type="pos" data-value="ADJ" data-abbrev="ADJ" style="background-color: #F1C40F; color: #000;" draggable="true">Adjective ADJ</div>
        <div class="palette-tile" data-type="pos" data-value="ADV" data-abbrev="ADV" style="background-color: #3498DB; color: #000;" draggable="true">Adverb ADV</div>
      </div>
    </div>

    <div class="palette-section closed-class-section">
      <div class="palette-row">
        <div class="palette-tile" data-type="pos" data-value="DET" data-abbrev="DET" style="background-color: #F39C12; color: #000;" draggable="true">Determiner DET</div>
        <div class="palette-tile" data-type="pos" data-value="PRON" data-abbrev="PRON" style="background-color: #E67E22; color: #000;" draggable="true">Pronoun PRON</div>
        <div class="palette-tile" data-type="pos" data-value="PREP" data-abbrev="PREP" style="background-color: #7D3C98; color: #000;" draggable="true">Preposition PREP</div>
        <div class="palette-tile" data-type="pos" data-value="CONJ" data-abbrev="CONJ" style="background-color: #95A5A6; color: #000;" draggable="true">Conjunction CONJ</div>
        <div class="palette-tile" data-type="pos" data-value="MOD" data-abbrev="MOD" style="background-color: #A3E4D7; color: #000;" draggable="true">Modal MOD</div>
        <div class="palette-tile" data-type="pos" data-value="AUX" data-abbrev="AUX" style="background-color: #16A085; color: #000;" draggable="true">Auxiliary AUX</div>
        <div class="palette-tile" data-type="pos" data-value="SUB" data-abbrev="SUB" style="background-color: #D5DBDB; color: #000;" draggable="true">Subordinating Conjunction SUB</div>
        <div class="palette-tile" data-type="pos" data-value="REL" data-abbrev="REL" style="background-color: #FCF3CF; color: #000;" draggable="true">Relativizer REL</div>
        <div class="palette-tile" data-type="pos" data-value="COMP" data-abbrev="COMP" style="background-color: #FADBD8; color: #000;" draggable="true">Complementizer COMP</div>
      </div>
    </div>
  </div>

  <script src="tree-model.js"></script>
  <script src="bracket-parser.js"></script>
  <script src="bracket-serializer.js"></script>
  <script src="canvas-manager.js"></script>
  <script src="sync-engine.js"></script>
  <script src="app.js"></script>
</body>
</html>
